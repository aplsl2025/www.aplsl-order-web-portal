  <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ahanitya Order Portal</title>

  <style>
    :root { 
  --brand:#1b8ea6;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --danger:#dc2626;

  /* Doctor-friendly sizing */
  --base-font: 16px;
  --label-font: 13px;
  --input-font: 15px;
  --table-font: 14px;

  /* Accents */
  --accent-soft: rgba(27,142,166,.22);
  --accent-strong: rgba(27,142,166,.55);
}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#f7fbff,#eef5ff);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{position:relative;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid #e5e7eb;border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.08);overflow:hidden}
    h1{margin:0 0 10px;font-size:22px}
    h2{margin:0 0 12px;font-size:18px;color:#dfe8ff}
    .grid{display:grid;gap:14px}
    @media (min-width:860px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,textarea,select{width:100%;padding:11px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 14px;font-weight:700}
    .btn-primary{background:var(--brand);color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text)}
    .btn-danger{background:var(--danger);color:#1a0b0b}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(17,121,154,.15);border:1px solid rgba(17,121,154,.35);color:#bfefff;font-size:12px}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
    th{color:#cfe6ff;font-weight:700;background:rgba(255,255,255,.04)}
    .right{text-align:right}
    .hide{display:none !important}
    .note{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.18);font-size:12px;color:var(--muted)}
    .status{font-size:13px;margin-top:8px}
    .status.ok{color:#76ffb1}
    .status.err{color:#ff9aa4}
    .na-text{display:inline-block;color:var(--danger);font-weight:800;font-size:12px}
  
    /* --- Alignment fix: Order Details & Medicines table ONLY --- */
    .grid.grid-2{
      align-items: flex-start;
    }
    .grid.grid-2 > div{
      min-width: 0;
    }

    table{
      table-layout: fixed;
    }
        th:nth-child(1), td:nth-child(1){ width: 45px; }
    th:nth-child(2), td:nth-child(2){ width: 130px; }
    th:nth-child(3), td:nth-child(3){ width: 230px; }
    th:nth-child(4), td:nth-child(4){ width: 120px; } /* Price */
    th:nth-child(5), td:nth-child(5){ width: 130px; } /* Qty */
    th:nth-child(6), td:nth-child(6){ width: 160px; } /* Measurement */

    .qty{ width:100%; }
    .uom{ width:100%; }


    /* --- Order Details form alignment (no overlap) --- */
    #orderCard .grid.grid-2{
      display:grid;
      gap:14px;
      grid-auto-flow: row;
      align-items:start;
    }
    #orderCard .grid.grid-2 > div{
      min-width:0;
    }
    #orderCard .grid.grid-2 input,
    #orderCard .grid.grid-2 select,
    #orderCard .grid.grid-2 textarea{
      width:100%;
      display:block;
      min-width:0;
    }
    /* Desktop: strict 2-column layout */
    @media (min-width:860px){
      #orderCard .grid.grid-2{ grid-template-columns: 1fr 1fr; }
    }
    /* Mobile: stack fields */
    @media (max-width:859.98px){
      #orderCard .grid.grid-2{ grid-template-columns: 1fr; }
    }


/* --- Compact Order Details inputs (NO other sections affected) --- */
#orderCard input,
#orderCard select{
  padding:6px 10px;
  box-sizing:border-box;
}


/* --- Logo sizing (responsive & premium) --- */
/* --- Logo card stays white in BOTH themes --- */
.logo-card{
  background:#ffffff !important;
}
.logo-img{
  max-height:130px;
  max-width:400px;
  width:auto;
  object-fit:contain;
}


/* --- Section backgrounds (replace images in /assets/) --- */
#orderCard{
  background:
    linear-gradient(rgba(6,11,20,0.60), rgba(6,11,20,0.60)),
    url("       ");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

/* Select Medicines & Quantity background (scoped) */
#medSection{
  background:
    linear-gradient(rgba(10,18,35,0.40), rgba(10,18,35,0.40)),
    url("images/product portfolio (1).png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  padding:16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
}


/* --- Light theme input & dropdown styling --- */
input, textarea{
  background:#ffffff;
  color:#111827;
}

select{
  background:#ffffff;
  color:#000000 !important;
  font-weight:700;
}

select option{
  color:#000000;
  font-weight:700;
}


/* --- Brand accent line on cards --- */
.card::before{
  content:"";
  position:absolute;
  left:0; right:0; top:0;
  height:6px;
  background:linear-gradient(90deg,var(--accent-strong),var(--accent-soft));
}

/* --- Doctor-friendly typography --- */
body{font-size:var(--base-font)}
label{font-size:var(--label-font)}
input,textarea,select{font-size:var(--input-font)}
th,td{font-size:var(--table-font)}
h1{font-size:24px}
h2{font-size:19px}

/* Make form elements more readable on light theme */
input, textarea{
  background:#ffffff;
  color:#111827;
}
select{
  background:#ffffff;
  color:#000000 !important;
  font-weight:700;
}
select option{
  color:#000000;
  font-weight:700;
}

/* --- Theme toggle button --- */
.btn-toggle{
  background:transparent;
  border:1px solid rgba(15,23,42,.18);
  color:#0f172a;
}
.btn-toggle:hover{border-color:rgba(27,142,166,.55)}

/* --- Dark theme (toggle) --- */
body[data-theme="dark"]{
  --bg:#060b14;
  --card:#0f1a2b;
  --text:#f1f5ff;
  --muted:#9fb2cc;
  background:linear-gradient(180deg,#071022,#0b1220);
}
body[data-theme="dark"] .card{
  background:rgba(15,26,43,.90);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 8px 24px rgba(0,0,0,.35);
}
body[data-theme="dark"] .btn-toggle{
  border-color:rgba(255,255,255,.18);
  color:#f1f5ff;
}
body[data-theme="dark"] input,
body[data-theme="dark"] textarea,
body[data-theme="dark"] select{
  background:rgba(255,255,255,.06);
  color:var(--text);
  border:1px solid rgba(255,255,255,.12);
}
body[data-theme="dark"] select,
body[data-theme="dark"] select option{
  color:var(--text) !important;
  font-weight:700;
}
body[data-theme="dark"] th{background:rgba(255,255,255,.04); color:#cfe6ff}


/* --- Light mode visibility fixes (Status pill + Table + Section overlays) --- */

/* Status pill readable in light mode */
body:not([data-theme="dark"]) .pill{
  background:#e6f6fa;
  border:1px solid #1b8ea6;
  color:#0f172a;
  font-weight:600;
}

/* Light mode: use LIGHT overlays on section background images */
body:not([data-theme="dark"]) #orderCard{
  background:
    linear-gradient(rgba(255,255,255,0.40), rgba(255,255,255,0.40)),
    url("assets/order-bg.jpg");
}

body:not([data-theme="dark"]) #medSection{
  background:
    linear-gradient(rgba(255,255,255,0.90), rgba(255,255,255,0.90)),
    url("images/product portfolio (1).png");
  border:1px solid #e5e7eb;
}

/* Light mode: table text/borders readable */
body:not([data-theme="dark"]) th{
  color:#0f172a;
  background:#f1f5f9;
}
body:not([data-theme="dark"]) td{
  color:#0f172a;
}
body:not([data-theme="dark"]) th, 
body:not([data-theme="dark"]) td{
  border-bottom:1px solid #e5e7eb;
}


/* --- Fixed size + 2D scroll for Select Medicines & Quantity --- */
#medSection{
  /* Fixed box size (adjust if needed) */
  height: 520px;
  width: 100%;
  box-sizing: border-box;
  overflow: hidden; /* keep scroll only inside table area */
}

/* The scrollable area inside the section (both vertical + horizontal) */
#medSection .medScroll{
  height: calc(520px - 130px); /* leaves room for title + buttons + small notes */
  overflow-y: auto;
  overflow-x: auto;
  /* enables top-bottom + left-right scroll */
  -webkit-overflow-scrolling: touch;
  border-radius: 12px;
}


/* Ensure horizontal scroll appears when needed */
#medSection table{
  width: max-content;
  min-width: 1100px; /* forces horizontal scroll when container is narrower */
  border-collapse: collapse;
}

@media (max-width: 480px){
  #medSection{ height: 480px; }
  #medSection .medScroll{ height: calc(480px - 140px); }
  #medSection table{ width:max-content; min-width: 980px; }
}



/* Make sure scroll container allows full-width content */
#medSection .medScroll{
  white-space: nowrap;
}
#medSection .medScroll table,
#medSection .medScroll thead,
#medSection .medScroll tbody,
#medSection .medScroll tr{
  white-space: normal;
}
/* Login / Create Account: prevent overlap */
.login-row{
  display: flex;
  gap: 12px;
  align-items: flex-start;
  flex-wrap: wrap;          /* stacks on small screens */
}

.login-row .field{
  flex: 1 1 200px;          /* each column tries to be 50%, min 280px */
  min-width: 200px;
}

.login-row input{
  width: 100%;
  box-sizing: border-box;

}
#loginEmail,
#loginPass{
  height:38px;          /* fixed equal height */
  padding:6px 10px;     /* compact but neat */
  box-sizing:border-box;
  font-size:14px;
}


</style>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Firebase (Auth) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } 
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // âœ… 1) PUT YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "AIzaSyCneC5CT9qfM8myRfoMZ7N4efUezDYMbLY",
      authDomain: "ahanitya-order-app.firebaseapp.com",
      projectId: "ahanitya-order-app",
      appId: "1:107492901712:web:b53eed0e9934ff6f1b6255"
    };

    // âœ… 2) PUT YOUR EMAILJS DETAILS HERE
    const EMAILJS_PUBLIC_KEY = "bKeNAq67qFjMMOtmO";
    const EMAILJS_SERVICE_ID = "service_94vs7qt";
    const EMAILJS_TEMPLATE_ID = "template_9qtgzil";

    // Fixed receiver + WhatsApp
    const RECEIVER_EMAIL = "infoahanityapharmalifescellp@gmail.com";
    const WHATSAPP_NUMBER = "918487090212"; // +91 8487090212 (no +)

    // ---------- Init ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

    // ---------- UI Helpers ----------
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hide");
    const hide = (el) => el.classList.add("hide");

    // ---------- Medicines (Edit your list) ----------
    const MEDICINES = [
      // You can set state-wise price/discount like this:
      // pricesByState: { GJ:{doctor:140,wholeseller:130,retailer:120,stockist:125}, RJ:{doctor:145,wholeseller:135,retailer:125,stockist:130} }
      // discountsByState: { GJ:{doctor:5,wholeseller:8,retailer:10,stockist:7}, RJ:{doctor:3,wholeseller:6,retailer:8,stockist:5} }
      // defaultDiscounts: { doctor:0, wholeseller:0, retailer:0, stockist:0 }
      { brand: "AZIN-500", strength: "Azithromycin Tablets I.P 500 mg" , available: true , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "ASP", strength: "Aceclofenac 100 mg + Paracetamol 325 mg + Serratiopeptidase 15 mg" , available: true , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "A-SUNAC", strength: "Aceclofenac 100 mg + Paracetamol 325 mg" , available: true , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "APLSL-DiaMet", strength: "Glimepiride 2 mg + Metformin HCl (ER)" , available: false , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "APLSL-Lulizid", strength: "Luliconazole 1%" , available: false , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "Ahanitya-Ketozin", strength: "Ketoconazole 2%" , available: false , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "APLSL-Cutiderm", strength: "Itraconazole 1% + Ofloxacin 0.75% + Ornidazole 2% + Clobetasol 0.05%" , available: false , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "Ahanitya-AmbroLev", strength: "Ambroxol 60 mg + Levocetirizine 2.5 mg + Paracetamol 500 mg + Phenylephrine 5 mg" , available: false , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "PANTO-DSR", strength: "Pantoprazole 40 mg + Domperidone 30 mg" , available: true , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }},
      { brand: "LE-MONT", strength: "Montelukast 10 mg + Levocetirizine 5 mg" , available: true , prices: { doctor: null, wholeseller: null, retailer: null, stockist: null }}
    ];

    function renderMedicineRows() {
      const tbody = $("medBody");
      tbody.innerHTML = "";
      MEDICINES.forEach((item, idx) => {
        const keyRaw = `${item.brand} (${item.strength})`;
        const key = escapeHtml(keyRaw);

        // Availability (set available:false in MEDICINES to show Not Available)
        const isNA = (item.available === false);
        const qtyHtml = isNA
          ? `<span class="na-text">Not Available</span>`
          : `<input type="number" min="0" step="1" value="0" data-med="${key}" data-idx="${idx}" class="qty" style="max-width:110px">`;
        const uomHtml = isNA
          ? `<span class="na-text">â€”</span>`
          : `<select class="uom" data-uom-med="${key}" style="max-width:140px">
               <option value="Box">Box</option>
               <option value="Strip">Strip</option>
               <option value="Each">Each</option>
             </select>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(item.brand)}</td>
          <td>${escapeHtml(item.strength)}</td>
          <td class="right price-cell" data-idx="${idx}">â€”</td>
          <td class="right">
            ${isNA ? `<span class="na-text">â€”</span>` : `<input type="number" min="0" max="100" step="0.01" value="0" data-idx="${idx}" class="disc" style="max-width:110px">`}
          </td>
          <td class="right final-price-cell" data-idx="${idx}">â€”</td>
          <td class="right">${qtyHtml}</td>
          <td class="right">${uomHtml}</td>
`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(str) {
      return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }



// ---------- Role + State based Pricing & Discount ----------
// NOTE: UI hiding is not security. For true protection of PTR/PTS, use backend/Firestore rules.
const ROLE_LABEL = { doctor:"Doctor", wholeseller:"Wholeseller", retailer:"Retailer", stockist:"Stockist" };
const BUSINESS_TO_ROLE = {
  "Doctor":"doctor",
  "Wholeseller":"wholeseller",
  "Retailer":"retailer",
  "Stockist":"stockist",
  // optional mappings (keep your old options working)
  "Distributor":"wholeseller",
  "W/R":"retailer"
};

// Map common state names to codes used in price/discount tables
const STATE_CODE = {
  "gujarat":"GJ",
  "rajasthan":"RJ",
  "madhya pradesh":"MP",
  "maharashtra":"MH",
  "uttar pradesh":"UP",
  "delhi":"DL",
  "other":"OT",
  "":""
};

function normalizeStateCode(val){
  const k = String(val || "").trim().toLowerCase();
  return STATE_CODE[k] || k.toUpperCase().slice(0,2);
}

function getStoredRole(email){
  try { return localStorage.getItem("ahanitya_role_" + (email || "").toLowerCase()) || ""; }
  catch(e){ return ""; }
}
function setStoredRole(email, roleKey){
  try {
    if(!email) return;
    localStorage.setItem("ahanitya_role_" + email.toLowerCase(), roleKey || "");
  } catch(e){}
}
function getStoredState(email){
  try { return localStorage.getItem("ahanitya_state_" + (email || "").toLowerCase()) || ""; }
  catch(e){ return ""; }
}
function setStoredState(email, stateCode){
  try {
    if(!email) return;
    localStorage.setItem("ahanitya_state_" + email.toLowerCase(), stateCode || "");
  } catch(e){}
}

function roleKeyFromBusiness(businessVal){
  return BUSINESS_TO_ROLE[businessVal] || "";
}

// Price lookup priority:
// 1) item.pricesByState?.[STATE]?.[ROLE]
// 2) item.prices?.[ROLE]
function getPriceFor(item, roleKey, stateCode){
  if(!item || !roleKey) return null;
  const st = stateCode || "";
  const byState = item?.pricesByState?.[st]?.[roleKey];
  if(byState !== null && byState !== undefined && byState !== "") return Number(byState);
  const base = item?.prices?.[roleKey];
  if(base !== null && base !== undefined && base !== "") return Number(base);
  return null;
}

// Discount lookup priority:
// 1) item.discountsByState?.[STATE]?.[ROLE]
// 2) item.defaultDiscounts?.[ROLE]
// 3) 0
function getDefaultDiscountFor(item, roleKey, stateCode){
  if(!item || !roleKey) return 0;
  const st = stateCode || "";
  const d1 = item?.discountsByState?.[st]?.[roleKey];
  if(d1 !== null && d1 !== undefined && d1 !== "") return Number(d1);
  const d2 = item?.defaultDiscounts?.[roleKey];
  if(d2 !== null && d2 !== undefined && d2 !== "") return Number(d2);
  return 0;
}

let CURRENT_ROLE_KEY = "";
let CURRENT_STATE_CODE = "";

function applyPriceUI(roleKey, stateCode){
  CURRENT_ROLE_KEY = roleKey || "";
  CURRENT_STATE_CODE = stateCode || "";

  const head = document.getElementById("priceHead");
  if (head) {
    const roleLabel = CURRENT_ROLE_KEY ? ("Price to " + (ROLE_LABEL[CURRENT_ROLE_KEY] || CURRENT_ROLE_KEY)) : "Price";
    head.textContent = CURRENT_STATE_CODE ? (roleLabel + " (" + CURRENT_STATE_CODE + ")") : roleLabel;
  }

  // update all price cells
  document.querySelectorAll(".price-cell").forEach(td => {
    const idx = Number(td.getAttribute("data-idx"));
    const item = MEDICINES[idx];
    const val = getPriceFor(item, CURRENT_ROLE_KEY, CURRENT_STATE_CODE);
    td.textContent = (val === null || !isFinite(val)) ? "â€”" : String(val.toFixed(2));
  });

  // apply default discounts (only if user hasn't manually edited)
  document.querySelectorAll(".disc").forEach(inp => {
    const idx = Number(inp.getAttribute("data-idx"));
    const item = MEDICINES[idx];
    if (inp.dataset.userEdited === "1") return; // keep user's manual override
    const defD = getDefaultDiscountFor(item, CURRENT_ROLE_KEY, CURRENT_STATE_CODE);
    inp.value = isFinite(defD) ? String(defD) : "0";
  });

  updateFinalPrices();
}

function updateFinalPrices(){
  document.querySelectorAll(".final-price-cell").forEach(td => {
    const idx = Number(td.getAttribute("data-idx"));
    const item = MEDICINES[idx];

    const base = getPriceFor(item, CURRENT_ROLE_KEY, CURRENT_STATE_CODE);
    const discInp = document.querySelector('.disc[data-idx="'+idx+'"]');
    const disc = discInp ? Number(discInp.value || 0) : 0;

    if (base === null || !isFinite(base) || !CURRENT_ROLE_KEY) {
      td.textContent = "â€”";
      return;
    }
    const finalVal = Number(base) * (1 - (disc/100));
    td.textContent = isFinite(finalVal) ? finalVal.toFixed(2) : "â€”";
  });
}

// Live update when discount changes (mark user override)
document.addEventListener("input", (e) => {
  if (e.target && e.target.classList && e.target.classList.contains("disc")) {
    e.target.dataset.userEdited = "1";
    updateFinalPrices();
  }
});

function applyRoleAndStateFromLogin(){
  const user = auth.currentUser;
  const email = user?.email || "";

  const businessSel = document.getElementById("custBusiness");
  const stateSel = document.getElementById("custState");
  if (!businessSel || !stateSel) return;

  const savedRole = getStoredRole(email);
  const savedState = getStoredState(email);

  // Restore / lock business type for this login
  if (savedRole) {
    const businessName = Object.keys(BUSINESS_TO_ROLE).find(k => BUSINESS_TO_ROLE[k] === savedRole) || "";
    if (businessName) businessSel.value = businessName;
    businessSel.disabled = true;
  } else {
    businessSel.disabled = false;
  }

  // Restore state if saved
  if (savedState) {
    // try set by code -> name not stored; we store code, so we just keep select value if matches known states
    const reverse = Object.entries(STATE_CODE).reduce((acc,[k,v]) => (acc[v]=k, acc), {});
    const nameKey = reverse[savedState] || "";
    if (nameKey) {
      // convert key back to Title Case label in dropdown
      const label = nameKey.split(" ").map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(" ");
      stateSel.value = label;
    }
  }

  // If no state selected yet, default to Gujarat (can be changed anytime)
  if (!stateSel.value) stateSel.value = "Gujarat";


  const roleKey = savedRole || roleKeyFromBusiness(businessSel.value || "");
  const stateCode = normalizeStateCode(stateSel.value || "");

  if (roleKey) setStoredRole(email, roleKey);
  if (stateCode) setStoredState(email, stateCode);

  applyPriceUI(roleKey, stateCode);
}

// React to Business Type change (only when not locked)
document.addEventListener("change", (e) => {
  if (e.target && e.target.id === "custBusiness") {
    const email = auth.currentUser?.email || "";
    const roleKey = roleKeyFromBusiness(e.target.value || "");
    const stateCode = normalizeStateCode(document.getElementById("custState")?.value || "");
    if (roleKey) setStoredRole(email, roleKey);
    applyPriceUI(roleKey, stateCode);
  }
});

// React to State change
document.addEventListener("change", (e) => {
  if (e.target && e.target.id === "custState") {
    const email = auth.currentUser?.email || "";
    const stateCode = normalizeStateCode(e.target.value || "");
    if (stateCode) setStoredState(email, stateCode);

    // reset userEdited so defaults can re-apply on state change (optional)
    document.querySelectorAll(".disc").forEach(inp => { inp.dataset.userEdited = ""; });

    const roleKey = getStoredRole(email) || roleKeyFromBusiness(document.getElementById("custBusiness")?.value || "");
    applyPriceUI(roleKey, stateCode);
  }
});


function getOrderItems() {
      const qtyInputs = Array.from(document.querySelectorAll(".qty"));
      const uomInputs = Array.from(document.querySelectorAll(".uom"));

      // Build a map: medicine -> unit
      const uomMap = new Map(
        uomInputs.map(sel => [sel.getAttribute("data-uom-med"), sel.value])
      );

      const items = qtyInputs
        .map(inp => {
          const med = inp.getAttribute("data-med");
          const idx = Number(inp.getAttribute("data-idx"));
          const uom = uomMap.get(med) || "Box";

          // role key (locked per login if saved)
          const email = auth.currentUser?.email || "";
          const roleKey = getStoredRole(email) || roleKeyFromBusiness(document.getElementById("custBusiness")?.value || "");
          const stateCode = normalizeStateCode(document.getElementById("custState")?.value || "");
          const base = getPriceFor(MEDICINES?.[idx], roleKey, stateCode);

          const discInp = document.querySelector('.disc[data-idx="'+idx+'"]');
          const discount_pct = discInp ? Number(discInp.value || 0) : 0;

          const final_price = (base === null || !isFinite(base)) ? null : (Number(base) * (1 - discount_pct/100));

          return {
            med,
            qty: Number(inp.value || 0),
            uom,
            unit_price: (base === null || !isFinite(base)) ? null : Number(base),
            discount_pct,
            final_price: (final_price === null || !isFinite(final_price)) ? null : Number(final_price.toFixed(2))
          };
        })
        .filter(x => x.qty > 0);

      return items;
    }

    function buildOrderText(payload) {
      const lines = [];
      lines.push("ðŸ“¦ *Ahanitya Order*");
      lines.push("");
      lines.push(`ðŸ‘¤ Name: ${payload.customer_name}`);
      lines.push(`ðŸ“ Address: ${payload.customer_address}`);
      lines.push(`ðŸ“§ Email: ${payload.customer_email}`);
      lines.push(`ðŸ“ž Contact: ${payload.customer_phone}`);
      lines.push(`ðŸ¢ Business Type: ${payload.business_type || ""}`);
      lines.push(`ðŸ—ºï¸ State: ${payload.customer_state || ""} ${payload.state_code ? ("(" + payload.state_code + ")") : ""}`);
      lines.push(`ðŸ‘¥ Referred By: ${payload.referred_by}`);
      if (payload.referred_by === "Yes") {
        lines.push(`ðŸ™ Referrer Name: ${payload.referrer_name}`);
        lines.push(`ðŸŽ“ Referrer Designation: ${payload.referrer_designation}`);
        if (payload.referrer_email) {
          lines.push(`ðŸ“§ Referrer Email: ${payload.referrer_email}`);
        }
      }
      lines.push("");
      lines.push("ðŸ’Š *Medicines Ordered:*");
      payload.items.forEach((it, i) => {
        const p = (it.unit_price === null || it.unit_price === undefined) ? "â€”" : ("â‚¹"+Number(it.unit_price).toFixed(2));
        const d = (it.discount_pct === null || it.discount_pct === undefined) ? "0" : String(it.discount_pct);
        const fp = (it.final_price === null || it.final_price === undefined) ? "â€”" : ("â‚¹"+Number(it.final_price).toFixed(2));
        lines.push(`${i+1}. ${it.med} â€” Qty: ${it.qty} ${it.uom} â€” Price: ${p} â€” Disc: ${d}% â€” Final: ${fp}`);
      });
      lines.push("");
      lines.push(`ðŸ—“ Date/Time: ${new Date().toLocaleString()}`);
      return lines.join("\n");
    }

    // ---------- Auth ----------
    onAuthStateChanged(auth, (user) => {
      if (user) {
        hide($("authCard"));
        show($("orderCard"));
        $("who").textContent = user.email;
        // Apply pricing column as per this login's saved category
        applyRoleAndStateFromLogin();
      } else {
        show($("authCard"));
        hide($("orderCard"));
        $("who").textContent = "";
      }
    });

    $("btnLogin").addEventListener("click", async () => {
      $("authStatus").textContent = "";
      const email = $("loginEmail").value.trim();
      const pass = $("loginPass").value.trim();
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        $("authStatus").textContent = "Logged in successfully âœ…";
        $("authStatus").className = "status ok";
      } catch (e) {
        $("authStatus").textContent = (e?.message || "Login failed");
        $("authStatus").className = "status err";
      }
    });

    $("btnSignup").addEventListener("click", async () => {
      $("authStatus").textContent = "";
      const email = $("loginEmail").value.trim();
      const pass = $("loginPass").value.trim();
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        $("authStatus").textContent = "Account created & logged in âœ…";
        $("authStatus").className = "status ok";
      } catch (e) {
        $("authStatus").textContent = (e?.message || "Sign-up failed");
        $("authStatus").className = "status err";
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
    });

    // ---------- Submit Order ----------
    $("btnSubmit").addEventListener("click", async () => {
      $("orderStatus").textContent = "";

      // Validate
      const items = getOrderItems();
      if (items.length === 0) {
        $("orderStatus").textContent = "Please select at least 1 medicine with quantity.";
        $("orderStatus").className = "status err";
        return;
      }

      const payload = {
        customer_name: $("custName").value.trim(),
        customer_address: $("custAddress").value.trim(),
        customer_email: $("custEmail").value.trim(),
        customer_phone: $("custPhone").value.trim(),
        receiver_email: RECEIVER_EMAIL,
        items,
        business_type: $("custBusiness") ? $("custBusiness").value.trim() : "",
        customer_state: $("custState") ? $("custState").value.trim() : "",
        state_code: normalizeStateCode($("custState") ? $("custState").value.trim() : ""),
        referred_by: $("referredFlag") ? $("referredFlag").value : "No",
        referrer_name: $("referrerName") ? $("referrerName").value.trim() : "",
        referrer_designation: $("referrerDesignation") ? $("referrerDesignation").value.trim() : "",
        referrer_email: $("referrerEmail") ? $("referrerEmail").value.trim() : "",
      };

      if (!payload.customer_name || !payload.customer_address || !payload.customer_email || !payload.customer_phone || !payload.business_type) {
        $("orderStatus").textContent = "Please fill Name, Address, Email, Contact No and Business Type.";
        $("orderStatus").className = "status err";
        return;
      }

      const orderText = buildOrderText(payload);

      // 1) Send Email via EmailJS
      try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
          // IMPORTANT: Your EmailJS template "To Email" should be set to {{to_email}} OR fixed to the receiver.
          // We pass to_email here to avoid "recipient address is empty".
          to_email: RECEIVER_EMAIL,

          // These keys MUST match your EmailJS template variables like:
          // {{customer_name}}, {{customer_email}}, {{customer_phone}}, {{customer_address}}, {{order_details}}
          customer_name: payload.customer_name,
          customer_email: payload.customer_email,
          customer_phone: payload.customer_phone,
          customer_address: payload.customer_address,
          order_details: orderText,
          business_type: payload.business_type
        });

        // 2) Open WhatsApp with prefilled message
        const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(orderText)}`;
        window.open(waUrl, "_blank", "noopener,noreferrer");

        $("orderStatus").textContent = "Order submitted âœ… Email sent + WhatsApp opened.";
        $("orderStatus").className = "status ok";

      } catch (e) {
        $("orderStatus").textContent = "Email sending failed: " + (e?.text || e?.message || "Unknown error") + " (check EmailJS service/template & Gmail permission).";
        $("orderStatus").className = "status err";
        console.error(e);
      }
    });

    // Init page
    renderMedicineRows();
    bindBusinessTypeToPricing();
    // If user is already logged in and role exists, apply immediately
    applyRoleAndStateFromLogin();

    // Top submit button triggers same action
    const btnSubmitTop = document.getElementById("btnSubmitTop");
    if (btnSubmitTop) {
      btnSubmitTop.addEventListener("click", () => {
        document.getElementById("btnSubmit").click();
      });
    }


    const referredFlag = document.getElementById("referredFlag");
    const ref1 = document.getElementById("referrerFields");
    const ref2 = document.getElementById("referrerFields2");

    if (referredFlag) {
      referredFlag.addEventListener("change", () => {
        if (referredFlag.value === "Yes") {
          ref1.style.display = "block";
          ref2.style.display = "block";
          document.getElementById("referrerFields3").style ("display","block");
        } else {
          ref1.style.display = "none";
          ref2.style.display = "none";
          document.getElementById("referrerFields3").style ("display","none");
        }
      });
    }

    $("custEmail").addEventListener("focus", () => {
      // auto-fill customer email from logged-in user (optional)
      const user = auth.currentUser;
      if (user && !$("custEmail").value) $("custEmail").value = user.email || "";
    });

  </script>
</head>

<body>
  <div class="wrap">

    <!-- Logo Display Card -->
<div class="card logo-card" style="margin-bottom:14px; text-align:center; padding:15px;">

  <div style="display:flex; justify-content:center; align-items:flex-start; gap:25px; flex-wrap:nowrap;">

    <!-- Ahanitya Logo -->
    <div style="display:flex; flex-direction:column; align-items:center; justify-content:flex-start;">
      <img src="images/without BG.png"
           alt="Ahanitya Pharma Life Science LLP"
           style="height:100px;">
      <p style="margin:8px 0 0 0; font-weight:600; color:#11799A; white-space:nowrap;">
        Ahanitya Pharma Life Science LLP
      </p>
    </div>

    <!-- Divider Line -->
    <div style="width:1px; height:60px; background:#ccc;"></div>

    <!-- Associate Sales Channel Partner Logo -->
    <div style="display:flex; flex-direction:column; align-items:center; justify-content:flex-start;">
      <img src="images/SBT.png"
           alt="Associate Sales Channel Partner"
           style="height:100px;">
      <p style="margin:8px 0 0 0; font-weight:600; color:#444; white-space:nowrap;">
        In association with Sales Channel Partner
      </p>
    </div>

  </div>
</div>


    <div class="card" style="margin-bottom:14px">
      <h1>Ahanitya Pharma Order Portal</h1>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="muted">
          Status: <span class="pill" id="who">Not logged in</span>
        </div>
        <button class="btn btn-ghost btn-toggle" id="btnTheme" type="button">Dark Mode</button>
        <button class="btn btn-ghost" id="btnLogout">Logout</button>
      </div>
    </div>

    <!-- AUTH -->
    <div class="card" id="authCard">
      <h2>Login / Create Account</h2>
      <div class="grid grid-2">
        <div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="yourname@email.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="Min 6 characters" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" id="btnLogin">Login</button>
        <button class="btn btn-ghost" id="btnSignup">Create Account</button>
      </div>
      <div class="status" id="authStatus"></div>

      <div class="note" style="margin-top:12px">
      <!--  You must add Firebase config + EmailJS keys inside the code. -->
      </div>
    </div>

    <!-- ORDER -->
    <div class="card hide" id="orderCard">
      <h2>Order Details</h2>

      <div class="grid grid-2">
        <div>
          <label>Name</label>
          <input id="custName" type="text" placeholder="Full Name" />
        </div>
        <div>
          <label>Contact No</label>
          <input id="custPhone" type="tel" placeholder="+91 XXXXX XXXXX" />
        </div>
        <div>
          <label>Mail ID</label>
          <input id="custEmail" type="email" placeholder="Customer email" />
        </div>
        <div>
          <label>Business Type</label>
          <select id="custBusiness">
            <option value="" selected disabled>Select business type</option>
            <option>Doctor</option>
            <option>Wholeseller</option>
            <option>Distributor</option>
            <option>Stockist</option>
            <option>Retailer</option>
            <option>W/R</option>
          </select>
        </div>

        <div>
          <label>State</label>
          <select id="custState">
            <option value="" selected disabled>Select state</option>
            <option>Gujarat</option>
            <option>Rajasthan</option>
            <option>Madhya Pradesh</option>
            <option>Maharashtra</option>
            <option>Uttar Pradesh</option>
            <option>Delhi</option>
            <option>Other</option>
          </select>
          <div class="muted" style="margin-top:6px">Pricing/discount will auto-adjust based on State + Business Type.</div>
        </div>
        <div>
          <label>Referred By</label>
          <select id="referredFlag">
            <option value="No" selected>No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>
        <div id="referrerFields" style="display:none;">
          <label>Referrer Name</label>
          <input id="referrerName" type="text" placeholder="Referrer full name" />
        </div>
        <div id="referrerFields2" style="display:none;">
          <label>Referrer Designation</label>
          <input id="referrerDesignation" type="text" placeholder="Doctor / MR / Distributor etc." />
        </div>

        <div>
          <label>Address</label>
          <input id="custAddress" type="text" placeholder="Full delivery address" />
        </div>
      </div>

      <div id="medSection" style="margin-top:14px">
        <h2 style="margin-bottom:10px">Select Medicines & Quantity</h2>

      <div class="row" style="margin-bottom:14px">
        <button class="btn btn-primary" id="btnSubmitTop">Submit Order (Email + WhatsApp)</button>
        <button class="btn btn-danger" onclick="location.reload()">Reset</button>
      </div>

        <div class="medScroll">
<table>
          <thead>
            <tr>
              <th>Sr No</th>
              <th>Brand Name</th>
              <th>Strength</th>
              <th class="right" id="priceHead">Price</th>
              <th class="right">Discount %</th>
              <th class="right">Final Price (â‚¹)</th>
              <th class="right">Quantity</th>
              <th class="right">Measurement</th>
            </tr>
          </thead>
          <tbody id="medBody"></tbody>
        </table>
        <div class="muted" style="margin-top:8px">Set quantity 0 for items not required.</div>
</div>

      
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn btn-primary" id="btnSubmit">Submit Order (Email + WhatsApp)</button>
        <button class="btn btn-danger" onclick="location.reload()">Reset</button>
      </div>

      <div class="status" id="orderStatus"></div>

      <div class="note" style="margin-top:12px">
        Orders will be emailed to <b>infoahanityapharmalifescellp@gmail.com</b> and also shared on WhatsApp to <b>+91 8487090212</b>.
        <p><strong>*</strong>Orders placed on or before 18:00 hrs (6:00 PM) will be processed and delivered on the same day, subject to stock availability and serviceable location.</p>
        <p><strong>*</strong>Orders placed after 18:00 hrs will be delivered on the next day, as early as possible. </p>
        <p><strong>*</strong>We accept and deliver orders on Sundays and public holidays as well. Same-day delivery applies for orders placed before 18:00 hrs, subject to availability.</p>
        <p><strong>*</strong>Bulk Order placed After 18:00 hrs will be delivered next day as early as possible. </p>
        <p><strong>*</strong>Emergency requirements may be accommodated on a priority basis (subject to availability).</p>
        <p><strong>*</strong>Same-day delivery is subject to product stock availability. In case of stock shortage, the customer will be informed immediately.</p>
        <p><strong>*</strong>Order changes or cancellations must be communicated before dispatch confirmation.</p>
        
      </div>
    </div>
  </div>

<script>
(function(){
  const KEY = "ahanitya_theme";
  const apply = (t) => {
    document.body.setAttribute("data-theme", t);
    const btn = document.getElementById("btnTheme");
    if (btn) btn.textContent = (t === "dark") ? "Light Mode" : "Dark Mode";
  };

  // init
  const saved = localStorage.getItem(KEY);
  apply(saved === "dark" ? "dark" : "light");

  // bind (button exists even when logged out)
  document.addEventListener("click", (e) => {
    if (e.target && e.target.id === "btnTheme") {
      const cur = document.body.getAttribute("data-theme") === "dark" ? "dark" : "light";
      const next = cur === "dark" ? "light" : "dark";
      localStorage.setItem(KEY, next);
      apply(next);
    }
  });
})();
</script>

</body>
</html>
