<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ahanitya Order Portal</title>

  <style>
    :root { --brand:#11799A; --bg:#0b1220; --card:#111b2e; --text:#eaf0ff; --muted:#a9b6d6; --danger:#ff6b6b; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071022,#0b1220);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:rgba(17,27,46,.85);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.35);backdrop-filter:blur(6px)}
    h1{margin:0 0 10px;font-size:22px}
    h2{margin:0 0 12px;font-size:18px;color:#dfe8ff}
    .grid{display:grid;gap:14px}
    @media (min-width:860px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,textarea,select{width:100%;padding:11px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 14px;font-weight:700}
    .btn-primary{background:var(--brand);color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text)}
    .btn-danger{background:var(--danger);color:#1a0b0b}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(17,121,154,.15);border:1px solid rgba(17,121,154,.35);color:#bfefff;font-size:12px}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
    th{color:#cfe6ff;font-weight:700;background:rgba(255,255,255,.04)}
    .right{text-align:right}
    .hide{display:none !important}
    .note{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.05);border:1px dashed rgba(255,255,255,.18);font-size:12px;color:var(--muted)}
    .status{font-size:13px;margin-top:8px}
    .status.ok{color:#76ffb1}
    .status.err{color:#ff9aa4}
  </style>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Firebase (Auth) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } 
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // âœ… 1) PUT YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "AIzaSyCneC5CT9qfM8myRfoMZ7N4efUezDYMbLY",
      authDomain: "ahanitya-order-app.firebaseapp.com",
      projectId: "ahanitya-order-app",
      appId: "1:107492901712:web:b53eed0e9934ff6f1b6255"
    };

    // âœ… 2) PUT YOUR EMAILJS DETAILS HERE
    const EMAILJS_PUBLIC_KEY = "YOUR_EMAILJS_PUBLIC_KEY";
    const EMAILJS_SERVICE_ID = "service_94vs7qt";
    const EMAILJS_TEMPLATE_ID = "template_9qtgzil";

    // Fixed receiver + WhatsApp
    const RECEIVER_EMAIL = "infoahanityapharmalifescellp@gmail.com";
    const WHATSAPP_NUMBER = "918487090212"; // +91 8487090212 (no +)

    // ---------- Init ----------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // EmailJS init
    emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY });

    // ---------- UI Helpers ----------
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove("hide");
    const hide = (el) => el.classList.add("hide");

    // ---------- Medicines (Edit your list) ----------
    const MEDICINES = [
      "Pantoprazole + Domperidone (Capsule)",
      "Levocetirizine (Tablet)",
      "Montelukast + Levocetirizine (Tablet)",
      "Azithromycin (Tablet)",
      "Cefixime (Tablet)",
      "Paracetamol (Tablet)",
      "Vitamin D3 (Softgel)",
      "Multivitamin (Capsule)"
    ];

    function renderMedicineRows() {
      const tbody = $("medBody");
      tbody.innerHTML = "";
      MEDICINES.forEach((name, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td class="right">
            <input type="number" min="0" step="1" value="0" data-med="${escapeHtml(name)}" class="qty" style="max-width:110px">
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(str) {
      return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function getOrderItems() {
      const qtyInputs = Array.from(document.querySelectorAll(".qty"));
      const items = qtyInputs
        .map(inp => ({ med: inp.getAttribute("data-med"), qty: Number(inp.value || 0) }))
        .filter(x => x.qty > 0);

      return items;
    }

    function buildOrderText(payload) {
      const lines = [];
      lines.push("ðŸ“¦ *Ahanitya Order*");
      lines.push("");
      lines.push(`ðŸ‘¤ Name: ${payload.customer_name}`);
      lines.push(`ðŸ“ Address: ${payload.customer_address}`);
      lines.push(`ðŸ“§ Email: ${payload.customer_email}`);
      lines.push(`ðŸ“ž Contact: ${payload.customer_phone}`);
      lines.push("");
      lines.push("ðŸ’Š *Medicines Ordered:*");
      payload.items.forEach((it, i) => lines.push(`${i+1}. ${it.med} â€” Qty: ${it.qty}`));
      lines.push("");
      lines.push(`ðŸ—“ Date/Time: ${new Date().toLocaleString()}`);
      return lines.join("\n");
    }

    // ---------- Auth ----------
    onAuthStateChanged(auth, (user) => {
      if (user) {
        hide($("authCard"));
        show($("orderCard"));
        $("who").textContent = user.email;
      } else {
        show($("authCard"));
        hide($("orderCard"));
        $("who").textContent = "";
      }
    });

    $("btnLogin").addEventListener("click", async () => {
      $("authStatus").textContent = "";
      const email = $("loginEmail").value.trim();
      const pass = $("loginPass").value.trim();
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        $("authStatus").textContent = "Logged in successfully âœ…";
        $("authStatus").className = "status ok";
      } catch (e) {
        $("authStatus").textContent = (e?.message || "Login failed");
        $("authStatus").className = "status err";
      }
    });

    $("btnSignup").addEventListener("click", async () => {
      $("authStatus").textContent = "";
      const email = $("loginEmail").value.trim();
      const pass = $("loginPass").value.trim();
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        $("authStatus").textContent = "Account created & logged in âœ…";
        $("authStatus").className = "status ok";
      } catch (e) {
        $("authStatus").textContent = (e?.message || "Sign-up failed");
        $("authStatus").className = "status err";
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
    });

    // ---------- Submit Order ----------
    $("btnSubmit").addEventListener("click", async () => {
      $("orderStatus").textContent = "";

      // Validate
      const items = getOrderItems();
      if (items.length === 0) {
        $("orderStatus").textContent = "Please select at least 1 medicine with quantity.";
        $("orderStatus").className = "status err";
        return;
      }

      const payload = {
        customer_name: $("custName").value.trim(),
        customer_address: $("custAddress").value.trim(),
        customer_email: $("custEmail").value.trim(),
        customer_phone: $("custPhone").value.trim(),
        receiver_email: RECEIVER_EMAIL,
        items,
      };

      if (!payload.customer_name || !payload.customer_address || !payload.customer_email || !payload.customer_phone) {
        $("orderStatus").textContent = "Please fill Name, Address, Email and Contact No.";
        $("orderStatus").className = "status err";
        return;
      }

      const orderText = buildOrderText(payload);

      // 1) Send Email via EmailJS
      try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
          to_email: RECEIVER_EMAIL,
          subject: `New Order - ${payload.customer_name} (${payload.customer_phone})`,
          message: orderText
        });

        // 2) Open WhatsApp with prefilled message
        const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(orderText)}`;
        window.open(waUrl, "_blank", "noopener,noreferrer");

        $("orderStatus").textContent = "Order submitted âœ… Email sent + WhatsApp opened.";
        $("orderStatus").className = "status ok";

      } catch (e) {
        $("orderStatus").textContent = "Email sending failed. Please check EmailJS keys/template.";
        $("orderStatus").className = "status err";
        console.error(e);
      }
    });

    // Init page
    renderMedicineRows();
    $("custEmail").addEventListener("focus", () => {
      // auto-fill customer email from logged-in user (optional)
      const user = auth.currentUser;
      if (user && !$("custEmail").value) $("custEmail").value = user.email || "";
    });

  </script>
</head>

<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:14px">
      <h1>Ahanitya Pharma Order Portal</h1>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="muted">
          Status: <span class="pill" id="who">Not logged in</span>
        </div>
        <button class="btn btn-ghost" id="btnLogout">Logout</button>
      </div>
    </div>

    <!-- AUTH -->
    <div class="card" id="authCard">
      <h2>Login / Create Account</h2>
      <div class="grid grid-2">
        <div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="yourname@email.com" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="Min 6 characters" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn btn-primary" id="btnLogin">Login</button>
        <button class="btn btn-ghost" id="btnSignup">Create Account</button>
      </div>
      <div class="status" id="authStatus"></div>

      <div class="note" style="margin-top:12px">
        You must add Firebase config + EmailJS keys inside the code.
      </div>
    </div>

    <!-- ORDER -->
    <div class="card hide" id="orderCard">
      <h2>Order Details</h2>

      <div class="grid grid-2">
        <div>
          <label>Name</label>
          <input id="custName" type="text" placeholder="Full Name" />
        </div>
        <div>
          <label>Contact No</label>
          <input id="custPhone" type="tel" placeholder="+91 XXXXX XXXXX" />
        </div>
        <div>
          <label>Mail ID</label>
          <input id="custEmail" type="email" placeholder="Customer email" />
        </div>
        <div>
          <label>Address</label>
          <input id="custAddress" type="text" placeholder="Full delivery address" />
        </div>
      </div>

      <div style="margin-top:14px">
        <h2 style="margin-bottom:10px">Select Medicines & Quantity</h2>
        <table>
          <thead>
            <tr>
              <th>Medicine</th>
              <th class="right">Quantity</th>
            </tr>
          </thead>
          <tbody id="medBody"></tbody>
        </table>
        <div class="muted" style="margin-top:8px">Set quantity 0 for items not required.</div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn btn-primary" id="btnSubmit">Submit Order (Email + WhatsApp)</button>
        <button class="btn btn-danger" onclick="location.reload()">Reset</button>
      </div>

      <div class="status" id="orderStatus"></div>

      <div class="note" style="margin-top:12px">
        Orders will be emailed to <b>infoahanityapharmalifescellp@gmail.com</b> and also shared on WhatsApp to <b>+91 8487090212</b>.
      </div>
    </div>
  </div>
</body>
</html>
